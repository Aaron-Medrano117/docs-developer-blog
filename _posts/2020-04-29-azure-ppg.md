---
layout: post
title: "Using Azure Proximity Placement Groups"
date: 2020-04-29 00:00
comments: true
author: Jimmy Rudley
published: true
authorIsRacker: true
authorAvatar: 'https://en.gravatar.com/userimage/151177997/5bed7e07ee47533cbd34b951d463bcb7.jpg'
bio: "Jimmy Rudley is an Azure Architect at Rackspace and an active member of the Azure community. He focuses on solving large and complex architecture and automation problems within Azure."
categories:
    - Azure
metaTitle: "Using Azure Proximity Placement Groups"
metaDescription: "Configure Azure&reg; Proximity Placement Groups."
ogTitle: "Using Azure Proximity Placement Groups"
ogDescription: "Configure Azure&reg; Proximity Placement Groups."
---

Azure&reg; Proximity Placement Groups is one feature of Azure&reg; that I hardly see implemented for IaaS solutions. Is it a lack of knowledge that this feature exists or just one of the many components people forget when architecting? For those that do not know what a proximity placement group is, it is a logical grouping that tries to keep your virtual machines physically close to each other to reduce network latency between those VMs.

<!-- more -->

If an individual provisions a virtual machine and do not pick an availablity zone, that virtual machine could be placed in any datacenter within the region you chose. Think about building out a N tier architecture or a cluster. Those virtual machines could be spread across multiple datacenters and increase uncessecary latency for communication. The easy and free fix is to logically group your solution to one proxmity placement group. 

### Benchmarking results from a SolrCloud cluster

For a real-world test, I took a typical three node D4s_v3 SolrCloud cluster with accelerated networking enabled and provisioned it two times. One had the availablity set tied to a proximity placement group and the other did not. For my benchmarking tool of choice, I use [PsPing](https://docs.microsoft.com/en-us/sysinternals/downloads/psping). Microsoft also recommends [Latte](https://gallery.technet.microsoft.com/Latte-The-Windows-tool-for-ac33093b)

To setup a PsPing test, I choose one node with and without a proximity placement group as my server by specifying the **-s** switch with a source IP address and port it will bind with. IE) **psping -s 192.168.0.:5000**. On a node that has a proxmity placement group tied to it and the node with no proxmity placement group, I ran PsPing with the **-l** for a request size of 8k and **-n** to set 10000 as the number of send and recieves. I also passed **-h** with 100 to set my bucket count for my histogram to print out.

Without a proximity placement group, you can see the count column had a lowest latency of .20 with a count of 3829, .27 had 3740 and so forth. Lowest latency with highest count is important. This will show our overall sends and the latency it is coorelated with. We want a majority of the counts to be with the lowest latency.
![]({% asset_path 2020-04-29-azure-ppg/withoutPPG.png %})

With a proximity placement group, you can see the lowest latency was .19 and had a count of 6800. 
![]({% asset_path 2020-04-29-azure-ppg/withPPG.png %})

You can clearly see the nodes with a proximity placement group had the lowest latency with a majority of packets. If you are not designing for resiliency within a region, think about using a proximity placement group with your design patterns. For examples of adding a proximity placement group in your deployment, please reference the Microsoft [ARM Template example](https://azure.microsoft.com/en-us/blog/introducing-proximity-placement-groups/) or [PowerShell example](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/proximity-placement-groups)
